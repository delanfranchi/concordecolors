import '@supersoniks/concorde/core';
import {html, LitElement, css} from 'lit';
import {customElement, property, state, query} from 'lit/decorators.js';
import {tailwind} from './js/tailwind/sonic-tailwind.js';
import './js/pages/configuration/form.ts';
import './js/pages/configuration/generator.ts';
import chroma from 'chroma-js';
import {PublisherManager} from '@supersoniks/concorde/core/utils/PublisherProxy';
@customElement('concorde-app')
export class SonicComponent extends LitElement {
  static styles = [
    tailwind,
    css`
      * {
        box-sizing: border-box;
      }
      sonic-theme {
        --sc-font-family-base: 'Inter var', -apple-system, system-ui,
          BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial,
          sans-serif !important;
        --sc-border-width: max(2px, 0.15rem);
        font-feature-settings: 'case', 'calt', 'ss03';
      }
    `,
  ];
  @property({type: String}) themeCss?: string;
  @state() modalIsVisible = false;
  @query('#code') _code: HTMLPreElement | undefined;
  handleNewTheme(e: CustomEvent) {
    if (e.detail.css) {
      this.themeCss = `sonic-tickets-app::part(theme){${e.detail.css}}`;
    }
  }

  showModal() {
    this.modalIsVisible = true;
  }
  handleHideModal() {
    this.modalIsVisible = false;
  }
  copyCode(e: Event) {
    if (this._code) {
      navigator.clipboard.writeText(this._code.innerText);
      if (e.target instanceof HTMLElement) {
        // set active attribute and remove after 2 seconds
        const targetElement = e.target;
        targetElement.setAttribute('active', '');
        setTimeout((el = e.target) => {
          targetElement.removeAttribute('active');
        }, 800);
      }
    }
  }
  randomise() {
    const RandomColor = chroma.random().hex();
    PublisherManager.get('themeSettings').primary = RandomColor;
  }

  render() {
    return html`
      <sonic-theme theme="auto" background color class="py-4 px-5">
        <div class="border-b flex gap-8 py-3 mb-8 items-center">
          <div class="text-4xl ">
            <sonic-link href="/" variant="unstyled">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="222.442"
                height="47.558"
                viewBox="0 0 222.442 47.558"
              >
                <g transform="translate(-51.885 -25)">
                  <path
                    d="M11.045.384A9.984,9.984,0,0,1,5.862-.9,8.546,8.546,0,0,1,2.538-4.474,11.519,11.519,0,0,1,1.381-9.741a11.462,11.462,0,0,1,1.17-5.3,8.651,8.651,0,0,1,3.33-3.567,9.872,9.872,0,0,1,5.139-1.285,10.228,10.228,0,0,1,4.5.933,7.522,7.522,0,0,1,3.055,2.621,7.7,7.7,0,0,1,1.24,3.963H14.676a4.017,4.017,0,0,0-1.144-2.371,3.328,3.328,0,0,0-2.423-.9,3.647,3.647,0,0,0-2.205.684A4.416,4.416,0,0,0,7.44-12.976a8.472,8.472,0,0,0-.524,3.158,8.75,8.75,0,0,0,.518,3.2A4.393,4.393,0,0,0,8.9-4.615a3.651,3.651,0,0,0,2.212.69,3.63,3.63,0,0,0,1.681-.384,3.279,3.279,0,0,0,1.24-1.119A4.261,4.261,0,0,0,14.676-7.2h5.139a8.049,8.049,0,0,1-1.221,3.957A7.443,7.443,0,0,1,15.584-.575,10.038,10.038,0,0,1,11.045.384Zm19.7,0A9.985,9.985,0,0,1,25.6-.888a8.6,8.6,0,0,1-3.343-3.554,11.411,11.411,0,0,1-1.176-5.3,11.469,11.469,0,0,1,1.176-5.325A8.6,8.6,0,0,1,25.6-18.62a9.985,9.985,0,0,1,5.146-1.272A9.985,9.985,0,0,1,35.9-18.62a8.6,8.6,0,0,1,3.343,3.554,11.469,11.469,0,0,1,1.176,5.325,11.411,11.411,0,0,1-1.176,5.3A8.6,8.6,0,0,1,35.9-.888,9.985,9.985,0,0,1,30.75.384Zm.026-4.219a3.367,3.367,0,0,0,2.263-.773,4.757,4.757,0,0,0,1.374-2.116A9.279,9.279,0,0,0,34.88-9.78a9.279,9.279,0,0,0-.467-3.055,4.8,4.8,0,0,0-1.374-2.122,3.35,3.35,0,0,0-2.263-.78,3.443,3.443,0,0,0-2.295.78,4.726,4.726,0,0,0-1.393,2.122,9.279,9.279,0,0,0-.467,3.055,9.279,9.279,0,0,0,.467,3.055,4.681,4.681,0,0,0,1.393,2.116A3.461,3.461,0,0,0,30.776-3.835Zm17.2-7.517V0H42.529V-19.636h5.19v3.464h.23a5.512,5.512,0,0,1,2.186-2.717,6.647,6.647,0,0,1,3.72-1A6.906,6.906,0,0,1,57.423-19a6.091,6.091,0,0,1,2.365,2.55,8.589,8.589,0,0,1,.844,3.944V0H55.185V-11.531a3.968,3.968,0,0,0-.92-2.819,3.315,3.315,0,0,0-2.57-1.016,3.87,3.87,0,0,0-1.937.473,3.253,3.253,0,0,0-1.3,1.374A4.769,4.769,0,0,0,47.975-11.352ZM72.346.384A9.985,9.985,0,0,1,67.162-.9a8.546,8.546,0,0,1-3.324-3.573,11.519,11.519,0,0,1-1.157-5.267,11.462,11.462,0,0,1,1.17-5.3,8.651,8.651,0,0,1,3.33-3.567,9.872,9.872,0,0,1,5.139-1.285,10.228,10.228,0,0,1,4.5.933,7.522,7.522,0,0,1,3.055,2.621,7.7,7.7,0,0,1,1.24,3.963H75.977a4.017,4.017,0,0,0-1.144-2.371,3.328,3.328,0,0,0-2.423-.9,3.647,3.647,0,0,0-2.205.684,4.416,4.416,0,0,0-1.464,1.988,8.472,8.472,0,0,0-.524,3.158,8.75,8.75,0,0,0,.518,3.2A4.393,4.393,0,0,0,70.2-4.615a3.651,3.651,0,0,0,2.212.69,3.63,3.63,0,0,0,1.681-.384,3.279,3.279,0,0,0,1.24-1.119A4.261,4.261,0,0,0,75.977-7.2h5.139A8.049,8.049,0,0,1,79.9-3.241,7.443,7.443,0,0,1,76.885-.575,10.038,10.038,0,0,1,72.346.384Zm19.7,0A9.985,9.985,0,0,1,86.905-.888a8.6,8.6,0,0,1-3.343-3.554,11.411,11.411,0,0,1-1.176-5.3,11.469,11.469,0,0,1,1.176-5.325,8.6,8.6,0,0,1,3.343-3.554,9.985,9.985,0,0,1,5.146-1.272A9.985,9.985,0,0,1,97.2-18.62a8.6,8.6,0,0,1,3.343,3.554,11.469,11.469,0,0,1,1.176,5.325,11.411,11.411,0,0,1-1.176,5.3A8.6,8.6,0,0,1,97.2-.888,9.985,9.985,0,0,1,92.051.384Zm.026-4.219a3.367,3.367,0,0,0,2.263-.773,4.757,4.757,0,0,0,1.374-2.116A9.279,9.279,0,0,0,96.18-9.78a9.279,9.279,0,0,0-.467-3.055,4.8,4.8,0,0,0-1.374-2.122,3.35,3.35,0,0,0-2.263-.78,3.443,3.443,0,0,0-2.295.78,4.726,4.726,0,0,0-1.393,2.122,9.278,9.278,0,0,0-.467,3.055,9.278,9.278,0,0,0,.467,3.055,4.681,4.681,0,0,0,1.393,2.116A3.461,3.461,0,0,0,92.077-3.835ZM103.83,0V-19.636h5.28v3.426h.2a5.1,5.1,0,0,1,1.8-2.768,4.76,4.76,0,0,1,2.915-.94,8.238,8.238,0,0,1,.882.051,6.212,6.212,0,0,1,.831.141v4.832a7.115,7.115,0,0,0-1.061-.2,9.532,9.532,0,0,0-1.24-.089,4.363,4.363,0,0,0-2.141.518,3.847,3.847,0,0,0-1.483,1.438,4.1,4.1,0,0,0-.543,2.122V0Zm19.59.32a7.351,7.351,0,0,1-4.046-1.157,7.876,7.876,0,0,1-2.864-3.413,13.041,13.041,0,0,1-1.055-5.542,12.858,12.858,0,0,1,1.087-5.619,7.829,7.829,0,0,1,2.9-3.362,7.4,7.4,0,0,1,3.969-1.119,6.1,6.1,0,0,1,2.755.556,5.484,5.484,0,0,1,1.79,1.381,7.22,7.22,0,0,1,1.042,1.617h.166v-9.844h5.433V0h-5.369V-3.145h-.23a7,7,0,0,1-1.08,1.617,5.443,5.443,0,0,1-1.8,1.323A6.249,6.249,0,0,1,123.42.32Zm1.726-4.334a3.487,3.487,0,0,0,2.231-.722,4.56,4.56,0,0,0,1.406-2.026,8.637,8.637,0,0,0,.492-3.055,8.632,8.632,0,0,0-.486-3.043,4.367,4.367,0,0,0-1.406-1.994,3.577,3.577,0,0,0-2.237-.7,3.532,3.532,0,0,0-2.263.729,4.456,4.456,0,0,0-1.393,2.02,8.677,8.677,0,0,0-.473,2.991,8.776,8.776,0,0,0,.479,3.023,4.56,4.56,0,0,0,1.393,2.045A3.485,3.485,0,0,0,125.146-4.014Zm21.418,4.4a10.412,10.412,0,0,1-5.21-1.234A8.345,8.345,0,0,1,138-4.353a11.538,11.538,0,0,1-1.176-5.376A11.479,11.479,0,0,1,138-15.047a8.681,8.681,0,0,1,3.317-3.567,9.628,9.628,0,0,1,5.031-1.278,10.393,10.393,0,0,1,3.624.62,8.169,8.169,0,0,1,2.94,1.86,8.473,8.473,0,0,1,1.962,3.113,12.434,12.434,0,0,1,.7,4.379v1.5H139V-11.8H150.45a4.172,4.172,0,0,0-.511-2.084,3.721,3.721,0,0,0-1.413-1.425,4.122,4.122,0,0,0-2.09-.518,4.193,4.193,0,0,0-2.192.569,4.08,4.08,0,0,0-1.489,1.521,4.333,4.333,0,0,0-.55,2.116v3.209a5.462,5.462,0,0,0,.543,2.518,3.889,3.889,0,0,0,1.54,1.636,4.653,4.653,0,0,0,2.365.575,5.15,5.15,0,0,0,1.662-.256,3.449,3.449,0,0,0,1.291-.767,3.335,3.335,0,0,0,.818-1.253l5.037.332A6.866,6.866,0,0,1,153.9-2.461a7.868,7.868,0,0,1-3.043,2.1A11.435,11.435,0,0,1,146.563.384Zm14.31-.051a2.954,2.954,0,0,1-2.167-.9,2.954,2.954,0,0,1-.9-2.167,2.919,2.919,0,0,1,.9-2.148,2.965,2.965,0,0,1,2.167-.895,2.985,2.985,0,0,1,2.148.895,2.889,2.889,0,0,1,.92,2.148,2.884,2.884,0,0,1-.428,1.54,3.286,3.286,0,0,1-1.119,1.112A2.9,2.9,0,0,1,160.873.332Z"
                    transform="translate(110.385 62)"
                    fill="currentColor"
                  ></path>
                  <g transform="translate(51.885 25)">
                    <g transform="translate(2.6 2.209)">
                      <path
                        d="M52.661,65.423h-1.4l-.091-.468h-.208l-.078.351-.078.065H49.646l-.065-.169-.091-.338h-.221v.208l-.118.065-3.859-.326L44.5,64.4v-.871a7.436,7.436,0,0,1,.156-1.079c.182-.883.546-1.962,2.833-5.224s3.08-4.481,4.665-10.3l.078-.324c.468-1.975.806-3.132.936-3.547V34.524a25.625,25.625,0,0,1,.312-2.82h0c.143-.923.312-1.754.468-2.4a21.623,21.623,0,0,0,.195,43.218,41.171,41.171,0,0,1-.845-6.8.668.668,0,0,0-.637-.3Z"
                        transform="translate(-33.181 -29.3)"
                        fill="currentColor"
                      ></path>
                      <path
                        d="M34.658,65.423h1.4l.091-.468h.209l.078.351.078.065h1.157l.065-.169.091-.338h.221v.208l.118.065,3.857-.326.793-.416v-.871a7.436,7.436,0,0,0-.156-1.079c-.182-.883-.546-1.962-2.833-5.224s-3.08-4.481-4.665-10.3l-.078-.324c-.468-1.975-.806-3.132-.936-3.547V34.524a25.63,25.63,0,0,0-.312-2.82h0c-.143-.923-.312-1.754-.468-2.4a21.623,21.623,0,0,1-.195,43.218,41.171,41.171,0,0,0,.845-6.8.668.668,0,0,1,.637-.3Z"
                        transform="translate(-11.738 -29.3)"
                        fill="currentColor"
                      ></path>
                    </g>
                    <path
                      d="M23.779,1.169a22.61,22.61,0,1,0,22.61,22.61,22.61,22.61,0,0,0-22.61-22.61m0-1.169A23.779,23.779,0,1,1,0,23.779,23.779,23.779,0,0,1,23.779,0Z"
                      transform="translate(0 0)"
                      fill="currentColor"
                    ></path>
                  </g>
                </g>
              </svg>
            </sonic-link>
          </div>
          <div class="flex ml-auto gap-2">
            <sonic-button
              @click=${this.randomise}
              variant="outline"
              type="primary"
              class="ml-auto block"
              ><sonic-icon
                library="heroicons"
                name="sparkles"
                slot="prefix"
                size="lg  "
              ></sonic-icon
              >Random</sonic-button
            >
            <sonic-button
              @click=${this.showModal}
              variant="outline"
              type="primary"
              class="ml-auto block"
              ><sonic-icon
                name="code"
                library="iconoir"
                slot="prefix"
                size="lg  "
              ></sonic-icon
              >Export CSS</sonic-button
            >
          </div>
        </div>
        <div class="grid grid-cols-[18rem,_auto] gap-10">
          <div>
            <concorde-configuration-form></concorde-configuration-form>
          </div>

          <div dataProvider="themeSettings">
            <concorde-theme-generator
              id="generator"
              @newTheme=${this.handleNewTheme}
            >
              <sonic-theme color>
                <sonic-theme-preview
                  class="block bg-neutral-50 p-10 rounded-lg"
                ></sonic-theme-preview>
              </sonic-theme>
            </concorde-theme-generator>
          </div>
        </div>

        <sonic-modal
          ?visible=${this.modalIsVisible}
          @hide=${this.handleHideModal}
        >
          <sonic-modal-title> Export css </sonic-modal-title>

          <pre
            id="code"
            class="text-xs bg-neutral-50 rounded-md text-content p-3 w-full max-h-[40vh] overflow-y-scroll"
          >
${this.themeCss
              ?.replaceAll(';', ';\n')
              .replaceAll('{', '{\n')
              .replaceAll('}', '\n}')
              .replaceAll('--', '  --')}</pre
          >
          <sonic-button
            @click=${this.copyCode}
            minWidth="8rem"
            class="mt-2"
            type="neutral"
            variant="outline"
            shape="block"
            ><sonic-icon
              name="copy"
              library="iconoir"
              slot="prefix"
              size="lg"
            ></sonic-icon
            ><span swap="off">copy</span
            ><span swap="on">copied</span></sonic-button
          >
        </sonic-modal>
      </sonic-theme>
    `;
  }
}
